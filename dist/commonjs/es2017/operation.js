'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.coalesceRecordOperations = coalesceRecordOperations;
exports.recordDiffs = recordDiffs;

var _record = require('./record');

var _utils = require('@orbit/utils');

function markOperationToDelete(operation) {
    const o = operation;
    o._deleted = true;
}
function isOperationMarkedToDelete(operation) {
    const o = operation;
    return o._deleted === true;
}
function mergeOperations(superceded, superceding, consecutiveOps) {
    if ((0, _record.equalRecordIdentities)(superceded.record, superceding.record)) {
        if (superceding.op === 'removeRecord') {
            markOperationToDelete(superceded);
            if (superceded.op === 'addRecord') {
                markOperationToDelete(superceding);
            }
        } else if (!isOperationMarkedToDelete(superceding) && (consecutiveOps || superceding.op === 'replaceAttribute')) {
            if (isReplaceFieldOp(superceded.op) && isReplaceFieldOp(superceding.op)) {
                if (superceded.op === 'replaceAttribute' && superceding.op === 'replaceAttribute' && superceded.attribute === superceding.attribute) {
                    markOperationToDelete(superceded);
                } else if (superceded.op === 'replaceRelatedRecord' && superceding.op === 'replaceRelatedRecord' && superceded.relationship === superceding.relationship) {
                    markOperationToDelete(superceded);
                } else if (superceded.op === 'replaceRelatedRecords' && superceding.op === 'replaceRelatedRecords' && superceded.relationship === superceding.relationship) {
                    markOperationToDelete(superceded);
                } else {
                    if (superceded.op === 'replaceAttribute') {
                        updateRecordReplaceAttribute(superceded.record, superceded.attribute, superceded.value);
                        delete superceded.attribute;
                        delete superceded.value;
                    } else if (superceded.op === 'replaceRelatedRecord') {
                        updateRecordReplaceHasOne(superceded.record, superceded.relationship, superceded.relatedRecord);
                        delete superceded.relationship;
                        delete superceded.relatedRecord;
                    } else if (superceded.op === 'replaceRelatedRecords') {
                        updateRecordReplaceHasMany(superceded.record, superceded.relationship, superceded.relatedRecords);
                        delete superceded.relationship;
                        delete superceded.relatedRecords;
                    }
                    if (superceding.op === 'replaceAttribute') {
                        updateRecordReplaceAttribute(superceded.record, superceding.attribute, superceding.value);
                    } else if (superceding.op === 'replaceRelatedRecord') {
                        updateRecordReplaceHasOne(superceded.record, superceding.relationship, superceding.relatedRecord);
                    } else if (superceding.op === 'replaceRelatedRecords') {
                        updateRecordReplaceHasMany(superceded.record, superceding.relationship, superceding.relatedRecords);
                    }
                    superceded.op = 'replaceRecord';
                    markOperationToDelete(superceding);
                }
            } else if ((superceded.op === 'addRecord' || superceded.op === 'replaceRecord') && isReplaceFieldOp(superceding.op)) {
                if (superceding.op === 'replaceAttribute') {
                    updateRecordReplaceAttribute(superceded.record, superceding.attribute, superceding.value);
                } else if (superceding.op === 'replaceRelatedRecord') {
                    updateRecordReplaceHasOne(superceded.record, superceding.relationship, superceding.relatedRecord);
                } else if (superceding.op === 'replaceRelatedRecords') {
                    updateRecordReplaceHasMany(superceded.record, superceding.relationship, superceding.relatedRecords);
                }
                markOperationToDelete(superceding);
            } else if (superceding.op === 'addToRelatedRecords') {
                if (superceded.op === 'addRecord') {
                    updateRecordAddToHasMany(superceded.record, superceding.relationship, superceding.relatedRecord);
                    markOperationToDelete(superceding);
                } else if (superceded.op === 'replaceRecord') {
                    if (superceded.record.relationships && superceded.record.relationships[superceding.relationship] && superceded.record.relationships[superceding.relationship].data) {
                        updateRecordAddToHasMany(superceded.record, superceding.relationship, superceding.relatedRecord);
                        markOperationToDelete(superceding);
                    }
                }
            } else if (superceding.op === 'removeFromRelatedRecords') {
                if (superceded.op === 'addToRelatedRecords' && superceded.relationship === superceding.relationship && (0, _record.equalRecordIdentities)(superceded.relatedRecord, superceding.relatedRecord)) {
                    markOperationToDelete(superceded);
                    markOperationToDelete(superceding);
                } else if (superceded.op === 'addRecord' || superceded.op === 'replaceRecord') {
                    if (superceded.record.relationships && superceded.record.relationships[superceding.relationship] && superceded.record.relationships[superceding.relationship].data) {
                        updateRecordRemoveFromHasMany(superceded.record, superceding.relationship, superceding.relatedRecord);
                        markOperationToDelete(superceding);
                    }
                }
            }
        }
    }
}
function isReplaceFieldOp(op) {
    return op === 'replaceAttribute' || op === 'replaceRelatedRecord' || op === 'replaceRelatedRecords';
}
function updateRecordReplaceAttribute(record, attribute, value) {
    record.attributes = record.attributes || {};
    record.attributes[attribute] = value;
}
function updateRecordReplaceHasOne(record, relationship, relatedRecord) {
    (0, _utils.deepSet)(record, ['relationships', relationship, 'data'], (0, _record.cloneRecordIdentity)(relatedRecord));
}
function updateRecordReplaceHasMany(record, relationship, relatedRecords) {
    (0, _utils.deepSet)(record, ['relationships', relationship, 'data'], relatedRecords.map(_record.cloneRecordIdentity));
}
function updateRecordAddToHasMany(record, relationship, relatedRecord) {
    const data = (0, _utils.deepGet)(record, ['relationships', relationship, 'data']) || [];
    data.push((0, _record.cloneRecordIdentity)(relatedRecord));
    (0, _utils.deepSet)(record, ['relationships', relationship, 'data'], data);
}
function updateRecordRemoveFromHasMany(record, relationship, relatedRecord) {
    const data = (0, _utils.deepGet)(record, ['relationships', relationship, 'data']);
    if (data) {
        for (let i = 0, l = data.length; i < l; i++) {
            let r = data[i];
            if ((0, _record.equalRecordIdentities)(r, relatedRecord)) {
                data.splice(i, 1);
                break;
            }
        }
    }
}
/**
 * Coalesces operations into a minimal set of equivalent operations.
 *
 * This method respects the order of the operations array and does not allow
 * reordering of operations that affect relationships.
 *
 * @export
 * @param {RecordOperation[]} operations
 * @returns {RecordOperation[]}
 */
function coalesceRecordOperations(operations) {
    for (let i = 0, l = operations.length; i < l; i++) {
        let currentOp = operations[i];
        let consecutiveOps = true;
        for (let j = i + 1; j < l; j++) {
            let nextOp = operations[j];
            mergeOperations(currentOp, nextOp, consecutiveOps);
            if (isOperationMarkedToDelete(currentOp)) {
                break;
            } else if (!isOperationMarkedToDelete(nextOp)) {
                consecutiveOps = false;
            }
        }
    }
    return operations.filter(o => !isOperationMarkedToDelete(o));
}
/**
 * Determine the differences between a record and its updated version in terms
 * of a set of operations.
 *
 * @export
 * @param {Record} record
 * @param {Record} updatedRecord
 * @returns {RecordOperation[]}
 */
function recordDiffs(record, updatedRecord) {
    const diffs = [];
    if (record && updatedRecord) {
        const recordIdentity = (0, _record.cloneRecordIdentity)(record);
        if (updatedRecord.attributes) {
            Object.keys(updatedRecord.attributes).forEach(attribute => {
                let value = updatedRecord.attributes[attribute];
                if (record.attributes === undefined || !(0, _utils.eq)(record.attributes[attribute], value)) {
                    let op = {
                        op: 'replaceAttribute',
                        record: recordIdentity,
                        attribute,
                        value
                    };
                    diffs.push(op);
                }
            });
        }
        if (updatedRecord.keys) {
            Object.keys(updatedRecord.keys).forEach(key => {
                let value = updatedRecord.keys[key];
                if (record.keys === undefined || !(0, _utils.eq)(record.keys[key], value)) {
                    let op = {
                        op: 'replaceKey',
                        record: recordIdentity,
                        key,
                        value
                    };
                    diffs.push(op);
                }
            });
        }
        // TODO - handle relationships
    }
    return diffs;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BlcmF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic3JjL29wZXJhdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLEFBQU8sQUFBMEIsQUFBbUIsQUFBRSxBQUFxQixBQUFFLEFBQU0sQUFBVSxBQUFDOztBQUM5RixBQUFPLEFBQUUsQUFBRSxBQUFFLEFBQU8sQUFBRSxBQUFPLEFBQUUsQUFBTSxBQUFjLEFBQUM7O0FBbUpwRCwrQkFBK0IsQUFBb0I7QUFDakQsVUFBTSxBQUFDLElBQVEsQUFBUyxBQUFDO0FBQ3pCLEFBQUMsTUFBQyxBQUFRLFdBQUcsQUFBSSxBQUFDLEFBQ3BCO0FBQUM7QUFFRCxtQ0FBbUMsQUFBb0I7QUFDckQsVUFBTSxBQUFDLElBQVEsQUFBUyxBQUFDO0FBQ3pCLEFBQU0sV0FBQyxBQUFDLEVBQUMsQUFBUSxhQUFLLEFBQUksQUFBQyxBQUM3QjtBQUFDO0FBRUQseUJBQXlCLEFBQTJCLFlBQUUsQUFBNEIsYUFBRSxBQUF1QjtBQUN6RyxBQUFFLEFBQUMsUUFBQyxBQUFxQixtQ0FBQyxBQUFVLFdBQUMsQUFBTSxRQUFFLEFBQVcsWUFBQyxBQUFNLEFBQUMsQUFBQyxTQUFDLEFBQUM7QUFDakUsQUFBRSxBQUFDLFlBQUMsQUFBVyxZQUFDLEFBQUUsT0FBSyxBQUFjLEFBQUMsZ0JBQUMsQUFBQztBQUN0QyxBQUFxQixrQ0FBQyxBQUFVLEFBQUMsQUFBQztBQUNsQyxBQUFFLEFBQUMsZ0JBQUMsQUFBVSxXQUFDLEFBQUUsT0FBSyxBQUFXLEFBQUMsYUFBQyxBQUFDO0FBQ2xDLEFBQXFCLHNDQUFDLEFBQVcsQUFBQyxBQUFDLEFBQ3JDO0FBQUMsQUFDSDtBQUFDLEFBQUMsQUFBSSxlQUFDLEFBQUUsQUFBQyxJQUFDLENBQUMsQUFBeUIsMEJBQUMsQUFBVyxBQUFDLEFBQUksaUJBQUMsQUFBYyxrQkFBSSxBQUFXLFlBQUMsQUFBRSxPQUFLLEFBQWtCLEFBQUMsQUFBQyxxQkFBQyxBQUFDO0FB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QztBQUM5RCx3QkFBSSxBQUFFO0FBQ0osQUFBRSw0QkFBRSxBQUFZO0FBQ2hCLEFBQU0sZ0NBQUUsQUFBYztBQUN0QixBQUFHO0FBQ0gsQUFBSyxBQUNOO0FBTDZCO0FBTzlCLEFBQUssMEJBQUMsQUFBSSxLQUFDLEFBQUUsQUFBQyxBQUFDLEFBQ2pCO0FBQUMsQUFDSDtBQUFDLEFBQUMsQUFBQyxBQUNMO0FBQUM7QUFFRCxBQUE4QixBQUNoQztBQUFDO0FBRUQsQUFBTSxXQUFDLEFBQUssQUFBQyxBQUNmO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZWNvcmQsIFJlY29yZElkZW50aXR5LCBjbG9uZVJlY29yZElkZW50aXR5LCBlcXVhbFJlY29yZElkZW50aXRpZXMgfSBmcm9tICcuL3JlY29yZCc7XG5pbXBvcnQgeyBlcSwgZGVlcEdldCwgZGVlcFNldCB9IGZyb20gJ0BvcmJpdC91dGlscyc7XG5cbi8qKlxuICogQmFzZSBPcGVyYXRpb24gaW50ZXJmYWNlLCB3aGljaCByZXF1aXJlcyBqdXN0IGFuIGBvcGAgc3RyaW5nLlxuICpcbiAqIEBleHBvcnRcbiAqIEBpbnRlcmZhY2UgT3BlcmF0aW9uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgT3BlcmF0aW9uIHtcbiAgb3A6IHN0cmluZztcbn1cblxuLyoqXG4gKiBBZGQgcmVjb3JkIG9wZXJhdGlvbi5cbiAqXG4gKiBAZXhwb3J0XG4gKiBAaW50ZXJmYWNlIEFkZFJlY29yZE9wZXJhdGlvblxuICogQGV4dGVuZHMge09wZXJhdGlvbn1cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBBZGRSZWNvcmRPcGVyYXRpb24gZXh0ZW5kcyBPcGVyYXRpb24ge1xuICBvcDogJ2FkZFJlY29yZCc7XG4gIHJlY29yZDogUmVjb3JkO1xufVxuXG4vKipcbiAqIFJlcGxhY2UgcmVjb3JkIG9wZXJhdGlvbi5cbiAqXG4gKiBAZXhwb3J0XG4gKiBAaW50ZXJmYWNlIFJlcGxhY2VSZWNvcmRPcGVyYXRpb25cbiAqIEBleHRlbmRzIHtPcGVyYXRpb259XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUmVwbGFjZVJlY29yZE9wZXJhdGlvbiBleHRlbmRzIE9wZXJhdGlvbiB7XG4gIG9wOiAncmVwbGFjZVJlY29yZCc7XG4gIHJlY29yZDogUmVjb3JkO1xufVxuXG4vKipcbiAqIFJlbW92ZSByZWNvcmQgb3BlcmF0aW9uLlxuICpcbiAqIEBleHBvcnRcbiAqIEBpbnRlcmZhY2UgUmVtb3ZlUmVjb3JkT3BlcmF0aW9uXG4gKiBAZXh0ZW5kcyB7T3BlcmF0aW9ufVxuICovXG5leHBvcnQgaW50ZXJmYWNlIFJlbW92ZVJlY29yZE9wZXJhdGlvbiBleHRlbmRzIE9wZXJhdGlvbiB7XG4gIG9wOiAncmVtb3ZlUmVjb3JkJztcbiAgcmVjb3JkOiBSZWNvcmRJZGVudGl0eTtcbn1cblxuLyoqXG4gKiBSZXBsYWNlIGtleSBvcGVyYXRpb24uXG4gKlxuICogQGV4cG9ydFxuICogQGludGVyZmFjZSBSZXBsYWNlS2V5T3BlcmF0aW9uXG4gKiBAZXh0ZW5kcyB7T3BlcmF0aW9ufVxuICovXG5leHBvcnQgaW50ZXJmYWNlIFJlcGxhY2VLZXlPcGVyYXRpb24gZXh0ZW5kcyBPcGVyYXRpb24ge1xuICBvcDogJ3JlcGxhY2VLZXknO1xuICByZWNvcmQ6IFJlY29yZElkZW50aXR5O1xuICBrZXk6IHN0cmluZztcbiAgdmFsdWU6IHN0cmluZztcbn1cblxuLyoqXG4gKiBSZXBsYWNlIGF0dHJpYnV0ZSBvcGVyYXRpb24uXG4gKlxuICogQGV4cG9ydFxuICogQGludGVyZmFjZSBSZXBsYWNlQXR0cmlidXRlT3BlcmF0aW9uXG4gKiBAZXh0ZW5kcyB7T3BlcmF0aW9ufVxuICovXG5leHBvcnQgaW50ZXJmYWNlIFJlcGxhY2VBdHRyaWJ1dGVPcGVyYXRpb24gZXh0ZW5kcyBPcGVyYXRpb24ge1xuICBvcDogJ3JlcGxhY2VBdHRyaWJ1dGUnO1xuICByZWNvcmQ6IFJlY29yZElkZW50aXR5O1xuICBhdHRyaWJ1dGU6IHN0cmluZztcbiAgdmFsdWU6IGFueTtcbn1cblxuLyoqXG4gKiBBZGQgdG8gaGFzLW1hbnkgcmVsYXRpb25zaGlwIG9wZXJhdGlvbi5cbiAqXG4gKiBAZXhwb3J0XG4gKiBAaW50ZXJmYWNlIEFkZFRvUmVsYXRlZFJlY29yZHNPcGVyYXRpb25cbiAqIEBleHRlbmRzIHtPcGVyYXRpb259XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQWRkVG9SZWxhdGVkUmVjb3Jkc09wZXJhdGlvbiBleHRlbmRzIE9wZXJhdGlvbiB7XG4gIG9wOiAnYWRkVG9SZWxhdGVkUmVjb3Jkcyc7XG4gIHJlY29yZDogUmVjb3JkSWRlbnRpdHk7XG4gIHJlbGF0aW9uc2hpcDogc3RyaW5nO1xuICByZWxhdGVkUmVjb3JkOiBSZWNvcmRJZGVudGl0eTtcbn1cblxuLyoqXG4gKiBSZW1vdmUgZnJvbSBoYXMtbWFueSByZWxhdGlvbnNoaXAgb3BlcmF0aW9uLlxuICpcbiAqIEBleHBvcnRcbiAqIEBpbnRlcmZhY2UgUmVtb3ZlRnJvbVJlbGF0ZWRSZWNvcmRzT3BlcmF0aW9uXG4gKiBAZXh0ZW5kcyB7T3BlcmF0aW9ufVxuICovXG5leHBvcnQgaW50ZXJmYWNlIFJlbW92ZUZyb21SZWxhdGVkUmVjb3Jkc09wZXJhdGlvbiBleHRlbmRzIE9wZXJhdGlvbiB7XG4gIG9wOiAncmVtb3ZlRnJvbVJlbGF0ZWRSZWNvcmRzJztcbiAgcmVjb3JkOiBSZWNvcmRJZGVudGl0eTtcbiAgcmVsYXRpb25zaGlwOiBzdHJpbmc7XG4gIHJlbGF0ZWRSZWNvcmQ6IFJlY29yZElkZW50aXR5O1xufVxuXG4vKipcbiAqIFJlcGxhY2UgaGFzLW1hbnkgcmVsYXRpb25zaGlwIG9wZXJhdGlvbi5cbiAqXG4gKiBAZXhwb3J0XG4gKiBAaW50ZXJmYWNlIFJlcGxhY2VSZWxhdGVkUmVjb3Jkc09wZXJhdGlvblxuICogQGV4dGVuZHMge09wZXJhdGlvbn1cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBSZXBsYWNlUmVsYXRlZFJlY29yZHNPcGVyYXRpb24gZXh0ZW5kcyBPcGVyYXRpb24ge1xuICBvcDogJ3JlcGxhY2VSZWxhdGVkUmVjb3Jkcyc7XG4gIHJlY29yZDogUmVjb3JkSWRlbnRpdHk7XG4gIHJlbGF0aW9uc2hpcDogc3RyaW5nO1xuICByZWxhdGVkUmVjb3JkczogUmVjb3JkSWRlbnRpdHlbXTtcbn1cblxuLyoqXG4gKiBSZXBsYWNlIGhhcy1vbmUgcmVsYXRpb25zaGlwIG9wZXJhdGlvbi5cbiAqXG4gKiBAZXhwb3J0XG4gKiBAaW50ZXJmYWNlIFJlcGxhY2VSZWxhdGVkUmVjb3JkT3BlcmF0aW9uXG4gKiBAZXh0ZW5kcyB7T3BlcmF0aW9ufVxuICovXG5leHBvcnQgaW50ZXJmYWNlIFJlcGxhY2VSZWxhdGVkUmVjb3JkT3BlcmF0aW9uIGV4dGVuZHMgT3BlcmF0aW9uIHtcbiAgb3A6ICdyZXBsYWNlUmVsYXRlZFJlY29yZCc7XG4gIHJlY29yZDogUmVjb3JkSWRlbnRpdHk7XG4gIHJlbGF0aW9uc2hpcDogc3RyaW5nO1xuICByZWxhdGVkUmVjb3JkOiBSZWNvcmRJZGVudGl0eSB8IG51bGw7XG59XG5cbi8qKlxuICogVW5pb24gb2YgYWxsIHJlY29yZC1yZWxhdGVkIG9wZXJhdGlvbnMuXG4gKlxuICogQGV4cG9ydFxuICovXG5leHBvcnQgdHlwZSBSZWNvcmRPcGVyYXRpb24gPSBBZGRSZWNvcmRPcGVyYXRpb24gfFxuICBSZXBsYWNlUmVjb3JkT3BlcmF0aW9uIHxcbiAgUmVtb3ZlUmVjb3JkT3BlcmF0aW9uIHxcbiAgUmVwbGFjZUtleU9wZXJhdGlvbiB8XG4gIFJlcGxhY2VBdHRyaWJ1dGVPcGVyYXRpb24gfFxuICBBZGRUb1JlbGF0ZWRSZWNvcmRzT3BlcmF0aW9uIHxcbiAgUmVtb3ZlRnJvbVJlbGF0ZWRSZWNvcmRzT3BlcmF0aW9uIHxcbiAgUmVwbGFjZVJlbGF0ZWRSZWNvcmRzT3BlcmF0aW9uIHxcbiAgUmVwbGFjZVJlbGF0ZWRSZWNvcmRPcGVyYXRpb247XG5cbmZ1bmN0aW9uIG1hcmtPcGVyYXRpb25Ub0RlbGV0ZShvcGVyYXRpb246IE9wZXJhdGlvbik6IHZvaWQge1xuICBjb25zdCBvOiBhbnkgPSBvcGVyYXRpb247XG4gIG8uX2RlbGV0ZWQgPSB0cnVlO1xufVxuXG5mdW5jdGlvbiBpc09wZXJhdGlvbk1hcmtlZFRvRGVsZXRlKG9wZXJhdGlvbjogT3BlcmF0aW9uKTogYm9vbGVhbiB7XG4gIGNvbnN0IG86IGFueSA9IG9wZXJhdGlvbjtcbiAgcmV0dXJuIG8uX2RlbGV0ZWQgPT09IHRydWU7XG59XG5cbmZ1bmN0aW9uIG1lcmdlT3BlcmF0aW9ucyhzdXBlcmNlZGVkOiBSZWNvcmRPcGVyYXRpb24sIHN1cGVyY2VkaW5nOiBSZWNvcmRPcGVyYXRpb24sIGNvbnNlY3V0aXZlT3BzOiBib29sZWFuKTogdm9pZCB7XG4gIGlmIChlcXVhbFJlY29yZElkZW50aXRpZXMoc3VwZXJjZWRlZC5yZWNvcmQsIHN1cGVyY2VkaW5nLnJlY29yZCkpIHtcbiAgICBpZiAoc3VwZXJjZWRpbmcub3AgPT09ICdyZW1vdmVSZWNvcmQnKSB7XG4gICAgICBtYXJrT3BlcmF0aW9uVG9EZWxldGUoc3VwZXJjZWRlZCk7XG4gICAgICBpZiAoc3VwZXJjZWRlZC5vcCA9PT0gJ2FkZFJlY29yZCcpIHtcbiAgICAgICAgbWFya09wZXJhdGlvblRvRGVsZXRlKHN1cGVyY2VkaW5nKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKCFpc09wZXJhdGlvbk1hcmtlZFRvRGVsZXRlKHN1cGVyY2VkaW5nKSAmJiAoY29uc2VjdXRpdmVPcHMgfHwgc3VwZXJjZWRpbmcub3AgPT09ICdyZXBsYWNlQXR0cmlidXRlJykpIHtcbiAgICAgIGlmIChpc1JlcGxhY2VGaWVsZE9wKHN1cGVyY2VkZWQub3ApICYmIGlzUmVwbGFjZUZpZWxkT3Aoc3VwZXJjZWRpbmcub3ApKSB7XG4gICAgICAgIGlmIChzdXBlcmNlZGVkLm9wID09PSAncmVwbGFjZUF0dHJpYnV0ZScgJiZcbiAgICAgICAgICAgIHN1cGVyY2VkaW5nLm9wID09PSAncmVwbGFjZUF0dHJpYnV0ZScgJiZcbiAgICAgICAgICAgIHN1cGVyY2VkZWQuYXR0cmlidXRlID09PSBzdXBlcmNlZGluZy5hdHRyaWJ1dGUpIHtcbiAgICAgICAgICBtYXJrT3BlcmF0aW9uVG9EZWxldGUoc3VwZXJjZWRlZCk7XG4gICAgICAgIH0gZWxzZSBpZiAoc3VwZXJjZWRlZC5vcCA9PT0gJ3JlcGxhY2VSZWxhdGVkUmVjb3JkJyAmJlxuICAgICAgICAgICAgc3VwZXJjZWRpbmcub3AgPT09ICdyZXBsYWNlUmVsYXRlZFJlY29yZCcgJiZcbiAgICAgICAgICAgIHN1cGVyY2VkZWQucmVsYXRpb25zaGlwID09PSBzdXBlcmNlZGluZy5yZWxhdGlvbnNoaXApIHtcbiAgICAgICAgICBtYXJrT3BlcmF0aW9uVG9EZWxldGUoc3VwZXJjZWRlZCk7XG4gICAgICAgIH0gZWxzZSBpZiAoc3VwZXJjZWRlZC5vcCA9PT0gJ3JlcGxhY2VSZWxhdGVkUmVjb3JkcycgJiZcbiAgICAgICAgICAgIHN1cGVyY2VkaW5nLm9wID09PSAncmVwbGFjZVJlbGF0ZWRSZWNvcmRzJyAmJlxuICAgICAgICAgICAgc3VwZXJjZWRlZC5yZWxhdGlvbnNoaXAgPT09IHN1cGVyY2VkaW5nLnJlbGF0aW9uc2hpcCkge1xuICAgICAgICAgIG1hcmtPcGVyYXRpb25Ub0RlbGV0ZShzdXBlcmNlZGVkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAoc3VwZXJjZWRlZC5vcCA9PT0gJ3JlcGxhY2VBdHRyaWJ1dGUnKSB7XG4gICAgICAgICAgICB1cGRhdGVSZWNvcmRSZXBsYWNlQXR0cmlidXRlKHN1cGVyY2VkZWQucmVjb3JkLCBzdXBlcmNlZGVkLmF0dHJpYnV0ZSwgc3VwZXJjZWRlZC52YWx1ZSk7XG4gICAgICAgICAgICBkZWxldGUgc3VwZXJjZWRlZC5hdHRyaWJ1dGU7XG4gICAgICAgICAgICBkZWxldGUgc3VwZXJjZWRlZC52YWx1ZTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHN1cGVyY2VkZWQub3AgPT09ICdyZXBsYWNlUmVsYXRlZFJlY29yZCcpIHtcbiAgICAgICAgICAgIHVwZGF0ZVJlY29yZFJlcGxhY2VIYXNPbmUoc3VwZXJjZWRlZC5yZWNvcmQsIHN1cGVyY2VkZWQucmVsYXRpb25zaGlwLCBzdXBlcmNlZGVkLnJlbGF0ZWRSZWNvcmQpO1xuICAgICAgICAgICAgZGVsZXRlIHN1cGVyY2VkZWQucmVsYXRpb25zaGlwO1xuICAgICAgICAgICAgZGVsZXRlIHN1cGVyY2VkZWQucmVsYXRlZFJlY29yZDtcbiAgICAgICAgICB9IGVsc2UgaWYgKHN1cGVyY2VkZWQub3AgPT09ICdyZXBsYWNlUmVsYXRlZFJlY29yZHMnKSB7XG4gICAgICAgICAgICB1cGRhdGVSZWNvcmRSZXBsYWNlSGFzTWFueShzdXBlcmNlZGVkLnJlY29yZCwgc3VwZXJjZWRlZC5yZWxhdGlvbnNoaXAsIHN1cGVyY2VkZWQucmVsYXRlZFJlY29yZHMpO1xuICAgICAgICAgICAgZGVsZXRlIHN1cGVyY2VkZWQucmVsYXRpb25zaGlwO1xuICAgICAgICAgICAgZGVsZXRlIHN1cGVyY2VkZWQucmVsYXRlZFJlY29yZHM7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChzdXBlcmNlZGluZy5vcCA9PT0gJ3JlcGxhY2VBdHRyaWJ1dGUnKSB7XG4gICAgICAgICAgICB1cGRhdGVSZWNvcmRSZXBsYWNlQXR0cmlidXRlKHN1cGVyY2VkZWQucmVjb3JkLCBzdXBlcmNlZGluZy5hdHRyaWJ1dGUsIHN1cGVyY2VkaW5nLnZhbHVlKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHN1cGVyY2VkaW5nLm9wID09PSAncmVwbGFjZVJlbGF0ZWRSZWNvcmQnKSB7XG4gICAgICAgICAgICB1cGRhdGVSZWNvcmRSZXBsYWNlSGFzT25lKHN1cGVyY2VkZWQucmVjb3JkLCBzdXBlcmNlZGluZy5yZWxhdGlvbnNoaXAsIHN1cGVyY2VkaW5nLnJlbGF0ZWRSZWNvcmQpO1xuICAgICAgICAgIH0gZWxzZSBpZiAoc3VwZXJjZWRpbmcub3AgPT09ICdyZXBsYWNlUmVsYXRlZFJlY29yZHMnKSB7XG4gICAgICAgICAgICB1cGRhdGVSZWNvcmRSZXBsYWNlSGFzTWFueShzdXBlcmNlZGVkLnJlY29yZCwgc3VwZXJjZWRpbmcucmVsYXRpb25zaGlwLCBzdXBlcmNlZGluZy5yZWxhdGVkUmVjb3Jkcyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHN1cGVyY2VkZWQub3AgPSAncmVwbGFjZVJlY29yZCc7XG4gICAgICAgICAgbWFya09wZXJhdGlvblRvRGVsZXRlKHN1cGVyY2VkaW5nKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICgoc3VwZXJjZWRlZC5vcCA9PT0gJ2FkZFJlY29yZCcgfHwgc3VwZXJjZWRlZC5vcCA9PT0gJ3JlcGxhY2VSZWNvcmQnKSAmJlxuICAgICAgICAgICAgICAgICBpc1JlcGxhY2VGaWVsZE9wKHN1cGVyY2VkaW5nLm9wKSkge1xuICAgICAgICBpZiAoc3VwZXJjZWRpbmcub3AgPT09ICdyZXBsYWNlQXR0cmlidXRlJykge1xuICAgICAgICAgIHVwZGF0ZVJlY29yZFJlcGxhY2VBdHRyaWJ1dGUoc3VwZXJjZWRlZC5yZWNvcmQsIHN1cGVyY2VkaW5nLmF0dHJpYnV0ZSwgc3VwZXJjZWRpbmcudmFsdWUpO1xuICAgICAgICB9IGVsc2UgaWYgKHN1cGVyY2VkaW5nLm9wID09PSAncmVwbGFjZVJlbGF0ZWRSZWNvcmQnKSB7XG4gICAgICAgICAgdXBkYXRlUmVjb3JkUmVwbGFjZUhhc09uZShzdXBlcmNlZGVkLnJlY29yZCwgc3VwZXJjZWRpbmcucmVsYXRpb25zaGlwLCBzdXBlcmNlZGluZy5yZWxhdGVkUmVjb3JkKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdXBlcmNlZGluZy5vcCA9PT0gJ3JlcGxhY2VSZWxhdGVkUmVjb3JkcycpIHtcbiAgICAgICAgICB1cGRhdGVSZWNvcmRSZXBsYWNlSGFzTWFueShzdXBlcmNlZGVkLnJlY29yZCwgc3VwZXJjZWRpbmcucmVsYXRpb25zaGlwLCBzdXBlcmNlZGluZy5yZWxhdGVkUmVjb3Jkcyk7XG4gICAgICAgIH1cbiAgICAgICAgbWFya09wZXJhdGlvblRvRGVsZXRlKHN1cGVyY2VkaW5nKTtcbiAgICAgIH0gZWxzZSBpZiAoc3VwZXJjZWRpbmcub3AgPT09ICdhZGRUb1JlbGF0ZWRSZWNvcmRzJykge1xuICAgICAgICBpZiAoc3VwZXJjZWRlZC5vcCA9PT0gJ2FkZFJlY29yZCcpIHtcbiAgICAgICAgICB1cGRhdGVSZWNvcmRBZGRUb0hhc01hbnkoc3VwZXJjZWRlZC5yZWNvcmQsIHN1cGVyY2VkaW5nLnJlbGF0aW9uc2hpcCwgc3VwZXJjZWRpbmcucmVsYXRlZFJlY29yZCk7XG4gICAgICAgICAgbWFya09wZXJhdGlvblRvRGVsZXRlKHN1cGVyY2VkaW5nKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdXBlcmNlZGVkLm9wID09PSAncmVwbGFjZVJlY29yZCcpIHtcbiAgICAgICAgICBpZiAoc3VwZXJjZWRlZC5yZWNvcmQucmVsYXRpb25zaGlwcyAmJlxuICAgICAgICAgICAgICBzdXBlcmNlZGVkLnJlY29yZC5yZWxhdGlvbnNoaXBzW3N1cGVyY2VkaW5nLnJlbGF0aW9uc2hpcF0gJiZcbiAgICAgICAgICAgICAgc3VwZXJjZWRlZC5yZWNvcmQucmVsYXRpb25zaGlwc1tzdXBlcmNlZGluZy5yZWxhdGlvbnNoaXBdLmRhdGEpIHtcbiAgICAgICAgICAgIHVwZGF0ZVJlY29yZEFkZFRvSGFzTWFueShzdXBlcmNlZGVkLnJlY29yZCwgc3VwZXJjZWRpbmcucmVsYXRpb25zaGlwLCBzdXBlcmNlZGluZy5yZWxhdGVkUmVjb3JkKTtcbiAgICAgICAgICAgIG1hcmtPcGVyYXRpb25Ub0RlbGV0ZShzdXBlcmNlZGluZyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHN1cGVyY2VkaW5nLm9wID09PSAncmVtb3ZlRnJvbVJlbGF0ZWRSZWNvcmRzJykge1xuICAgICAgICBpZiAoc3VwZXJjZWRlZC5vcCA9PT0gJ2FkZFRvUmVsYXRlZFJlY29yZHMnICYmXG4gICAgICAgICAgICBzdXBlcmNlZGVkLnJlbGF0aW9uc2hpcCA9PT0gc3VwZXJjZWRpbmcucmVsYXRpb25zaGlwICYmXG4gICAgICAgICAgICBlcXVhbFJlY29yZElkZW50aXRpZXMoc3VwZXJjZWRlZC5yZWxhdGVkUmVjb3JkLCBzdXBlcmNlZGluZy5yZWxhdGVkUmVjb3JkKSkge1xuICAgICAgICAgIG1hcmtPcGVyYXRpb25Ub0RlbGV0ZShzdXBlcmNlZGVkKTtcbiAgICAgICAgICBtYXJrT3BlcmF0aW9uVG9EZWxldGUoc3VwZXJjZWRpbmcpO1xuICAgICAgICB9IGVsc2UgaWYgKHN1cGVyY2VkZWQub3AgPT09ICdhZGRSZWNvcmQnIHx8IHN1cGVyY2VkZWQub3AgPT09ICdyZXBsYWNlUmVjb3JkJykge1xuICAgICAgICAgIGlmIChzdXBlcmNlZGVkLnJlY29yZC5yZWxhdGlvbnNoaXBzICYmXG4gICAgICAgICAgICAgIHN1cGVyY2VkZWQucmVjb3JkLnJlbGF0aW9uc2hpcHNbc3VwZXJjZWRpbmcucmVsYXRpb25zaGlwXSAmJlxuICAgICAgICAgICAgICBzdXBlcmNlZGVkLnJlY29yZC5yZWxhdGlvbnNoaXBzW3N1cGVyY2VkaW5nLnJlbGF0aW9uc2hpcF0uZGF0YSkge1xuICAgICAgICAgICAgdXBkYXRlUmVjb3JkUmVtb3ZlRnJvbUhhc01hbnkoc3VwZXJjZWRlZC5yZWNvcmQsIHN1cGVyY2VkaW5nLnJlbGF0aW9uc2hpcCwgc3VwZXJjZWRpbmcucmVsYXRlZFJlY29yZCk7XG4gICAgICAgICAgICBtYXJrT3BlcmF0aW9uVG9EZWxldGUoc3VwZXJjZWRpbmcpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBpc1JlcGxhY2VGaWVsZE9wKG9wOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgcmV0dXJuIChvcCA9PT0gJ3JlcGxhY2VBdHRyaWJ1dGUnIHx8XG4gICAgICAgICAgb3AgPT09ICdyZXBsYWNlUmVsYXRlZFJlY29yZCcgfHxcbiAgICAgICAgICBvcCA9PT0gJ3JlcGxhY2VSZWxhdGVkUmVjb3JkcycpO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVSZWNvcmRSZXBsYWNlQXR0cmlidXRlKHJlY29yZDogUmVjb3JkLCBhdHRyaWJ1dGU6IHN0cmluZywgdmFsdWU6IGFueSkge1xuICByZWNvcmQuYXR0cmlidXRlcyA9IHJlY29yZC5hdHRyaWJ1dGVzIHx8IHt9O1xuICByZWNvcmQuYXR0cmlidXRlc1thdHRyaWJ1dGVdID0gdmFsdWU7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZVJlY29yZFJlcGxhY2VIYXNPbmUocmVjb3JkOiBSZWNvcmQsIHJlbGF0aW9uc2hpcDogc3RyaW5nLCByZWxhdGVkUmVjb3JkOiBSZWNvcmRJZGVudGl0eSkge1xuICBkZWVwU2V0KHJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgcmVsYXRpb25zaGlwLCAnZGF0YSddLCBjbG9uZVJlY29yZElkZW50aXR5KHJlbGF0ZWRSZWNvcmQpKTtcbn1cblxuZnVuY3Rpb24gdXBkYXRlUmVjb3JkUmVwbGFjZUhhc01hbnkocmVjb3JkOiBSZWNvcmQsIHJlbGF0aW9uc2hpcDogc3RyaW5nLCByZWxhdGVkUmVjb3JkczogUmVjb3JkSWRlbnRpdHlbXSkge1xuICBkZWVwU2V0KHJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgcmVsYXRpb25zaGlwLCAnZGF0YSddLCByZWxhdGVkUmVjb3Jkcy5tYXAoY2xvbmVSZWNvcmRJZGVudGl0eSkpO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVSZWNvcmRBZGRUb0hhc01hbnkocmVjb3JkOiBSZWNvcmQsIHJlbGF0aW9uc2hpcDogc3RyaW5nLCByZWxhdGVkUmVjb3JkOiBSZWNvcmRJZGVudGl0eSkge1xuICBjb25zdCBkYXRhID0gZGVlcEdldChyZWNvcmQsIFsncmVsYXRpb25zaGlwcycsIHJlbGF0aW9uc2hpcCwgJ2RhdGEnXSkgfHwgW107XG4gIGRhdGEucHVzaChjbG9uZVJlY29yZElkZW50aXR5KHJlbGF0ZWRSZWNvcmQpKTtcbiAgZGVlcFNldChyZWNvcmQsIFsncmVsYXRpb25zaGlwcycsIHJlbGF0aW9uc2hpcCwgJ2RhdGEnXSwgZGF0YSk7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZVJlY29yZFJlbW92ZUZyb21IYXNNYW55KHJlY29yZDogUmVjb3JkLCByZWxhdGlvbnNoaXA6IHN0cmluZywgcmVsYXRlZFJlY29yZDogUmVjb3JkSWRlbnRpdHkpIHtcbiAgY29uc3QgZGF0YSA9IGRlZXBHZXQocmVjb3JkLCBbJ3JlbGF0aW9uc2hpcHMnLCByZWxhdGlvbnNoaXAsICdkYXRhJ10pIGFzIFJlY29yZElkZW50aXR5W107XG4gIGlmIChkYXRhKSB7XG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBkYXRhLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgbGV0IHIgPSBkYXRhW2ldO1xuICAgICAgaWYgKGVxdWFsUmVjb3JkSWRlbnRpdGllcyhyLCByZWxhdGVkUmVjb3JkKSkge1xuICAgICAgICBkYXRhLnNwbGljZShpLCAxKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogQ29hbGVzY2VzIG9wZXJhdGlvbnMgaW50byBhIG1pbmltYWwgc2V0IG9mIGVxdWl2YWxlbnQgb3BlcmF0aW9ucy5cbiAqXG4gKiBUaGlzIG1ldGhvZCByZXNwZWN0cyB0aGUgb3JkZXIgb2YgdGhlIG9wZXJhdGlvbnMgYXJyYXkgYW5kIGRvZXMgbm90IGFsbG93XG4gKiByZW9yZGVyaW5nIG9mIG9wZXJhdGlvbnMgdGhhdCBhZmZlY3QgcmVsYXRpb25zaGlwcy5cbiAqXG4gKiBAZXhwb3J0XG4gKiBAcGFyYW0ge1JlY29yZE9wZXJhdGlvbltdfSBvcGVyYXRpb25zXG4gKiBAcmV0dXJucyB7UmVjb3JkT3BlcmF0aW9uW119XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb2FsZXNjZVJlY29yZE9wZXJhdGlvbnMob3BlcmF0aW9uczogUmVjb3JkT3BlcmF0aW9uW10pOiBSZWNvcmRPcGVyYXRpb25bXSB7XG4gIGZvciAobGV0IGkgPSAwLCBsID0gb3BlcmF0aW9ucy5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICBsZXQgY3VycmVudE9wID0gb3BlcmF0aW9uc1tpXTtcbiAgICBsZXQgY29uc2VjdXRpdmVPcHMgPSB0cnVlO1xuXG4gICAgZm9yIChsZXQgaiA9IGkgKyAxOyBqIDwgbDsgaisrKSB7XG4gICAgICBsZXQgbmV4dE9wID0gb3BlcmF0aW9uc1tqXTtcblxuICAgICAgbWVyZ2VPcGVyYXRpb25zKGN1cnJlbnRPcCwgbmV4dE9wLCBjb25zZWN1dGl2ZU9wcyk7XG5cbiAgICAgIGlmIChpc09wZXJhdGlvbk1hcmtlZFRvRGVsZXRlKGN1cnJlbnRPcCkpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9IGVsc2UgaWYgKCFpc09wZXJhdGlvbk1hcmtlZFRvRGVsZXRlKG5leHRPcCkpIHtcbiAgICAgICAgY29uc2VjdXRpdmVPcHMgPSBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gb3BlcmF0aW9ucy5maWx0ZXIobyA9PiAhaXNPcGVyYXRpb25NYXJrZWRUb0RlbGV0ZShvKSk7XG59XG5cbi8qKlxuICogRGV0ZXJtaW5lIHRoZSBkaWZmZXJlbmNlcyBiZXR3ZWVuIGEgcmVjb3JkIGFuZCBpdHMgdXBkYXRlZCB2ZXJzaW9uIGluIHRlcm1zXG4gKiBvZiBhIHNldCBvZiBvcGVyYXRpb25zLlxuICpcbiAqIEBleHBvcnRcbiAqIEBwYXJhbSB7UmVjb3JkfSByZWNvcmRcbiAqIEBwYXJhbSB7UmVjb3JkfSB1cGRhdGVkUmVjb3JkXG4gKiBAcmV0dXJucyB7UmVjb3JkT3BlcmF0aW9uW119XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiByZWNvcmREaWZmcyhyZWNvcmQ6IFJlY29yZCwgdXBkYXRlZFJlY29yZDogUmVjb3JkKTogUmVjb3JkT3BlcmF0aW9uW10ge1xuICBjb25zdCBkaWZmczogUmVjb3JkT3BlcmF0aW9uW10gPSBbXTtcblxuICBpZiAocmVjb3JkICYmIHVwZGF0ZWRSZWNvcmQpIHtcbiAgICBjb25zdCByZWNvcmRJZGVudGl0eSA9IGNsb25lUmVjb3JkSWRlbnRpdHkocmVjb3JkKTtcblxuICAgIGlmICh1cGRhdGVkUmVjb3JkLmF0dHJpYnV0ZXMpIHtcbiAgICAgIE9iamVjdC5rZXlzKHVwZGF0ZWRSZWNvcmQuYXR0cmlidXRlcykuZm9yRWFjaChhdHRyaWJ1dGUgPT4ge1xuICAgICAgICBsZXQgdmFsdWUgPSB1cGRhdGVkUmVjb3JkLmF0dHJpYnV0ZXNbYXR0cmlidXRlXTtcblxuICAgICAgICBpZiAocmVjb3JkLmF0dHJpYnV0ZXMgPT09IHVuZGVmaW5lZCB8fCAhZXEocmVjb3JkLmF0dHJpYnV0ZXNbYXR0cmlidXRlXSwgdmFsdWUpKSB7XG4gICAgICAgICAgbGV0IG9wOiBSZXBsYWNlQXR0cmlidXRlT3BlcmF0aW9uID0ge1xuICAgICAgICAgICAgb3A6ICdyZXBsYWNlQXR0cmlidXRlJyxcbiAgICAgICAgICAgIHJlY29yZDogcmVjb3JkSWRlbnRpdHksXG4gICAgICAgICAgICBhdHRyaWJ1dGUsXG4gICAgICAgICAgICB2YWx1ZVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGRpZmZzLnB1c2gob3ApO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAodXBkYXRlZFJlY29yZC5rZXlzKSB7XG4gICAgICBPYmplY3Qua2V5cyh1cGRhdGVkUmVjb3JkLmtleXMpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgbGV0IHZhbHVlID0gdXBkYXRlZFJlY29yZC5rZXlzW2tleV07XG4gICAgICAgIGlmIChyZWNvcmQua2V5cyA9PT0gdW5kZWZpbmVkIHx8ICFlcShyZWNvcmQua2V5c1trZXldLCB2YWx1ZSkpIHtcbiAgICAgICAgICBsZXQgb3A6IFJlcGxhY2VLZXlPcGVyYXRpb24gPSB7XG4gICAgICAgICAgICBvcDogJ3JlcGxhY2VLZXknLFxuICAgICAgICAgICAgcmVjb3JkOiByZWNvcmRJZGVudGl0eSxcbiAgICAgICAgICAgIGtleSxcbiAgICAgICAgICAgIHZhbHVlXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZGlmZnMucHVzaChvcCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIFRPRE8gLSBoYW5kbGUgcmVsYXRpb25zaGlwc1xuICB9XG5cbiAgcmV0dXJuIGRpZmZzO1xufVxuIl19