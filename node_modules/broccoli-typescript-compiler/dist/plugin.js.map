{"version":3,"file":"plugin.js","sources":["../src/plugin.ts","../src/compiler.ts","../src/output-patcher.ts","../src/source-cache.ts","../src/utils.ts","../src/helpers.ts"],"sourcesContent":["import { BroccoliPlugin, getCallerFile, heimdall } from \"./helpers\";\nimport { readConfig, findConfig } from \"./utils\";\nimport Compiler from \"./compiler\";\n\nexport interface TypeScriptOptions {\n  tsconfig?: Object | string | undefined;\n  annotation?: string | undefined;\n}\n\nexport { findConfig } from \"./utils\";\n\nexport class TypeScript extends BroccoliPlugin {\n\n  config: Object;\n  configFileName: string | undefined;\n  host: Compiler | undefined;\n\n  constructor(inputTree: any, options?: TypeScriptOptions | undefined) {\n    super([ inputTree ], {\n      name: \"broccoli-typescript-compiler\",\n      persistentOutput: true,\n      annotation: options && options.annotation\n    });\n\n    let configFileName: string | undefined;\n    let config: any;\n    if (!options || !options.tsconfig) {\n      configFileName = findConfig(getCallerFile(2));\n      config = readConfig(configFileName);\n    } else if (typeof options.tsconfig === \"string\") {\n      configFileName = options.tsconfig;\n      config = readConfig(configFileName);\n    } else {\n      configFileName = undefined;\n      config = options.tsconfig;\n    }\n\n    this.config = config;\n    this.configFileName = configFileName;\n  }\n\n  build() {\n    let token = heimdall.start(\"TypeScript:compile\");\n    let inputPath = this.inputPaths[0];\n    let { host } = this;\n    if (!host) {\n      host = this.host = new Compiler(this.outputPath, inputPath, this.config, this.configFileName);\n    } else {\n      host.updateInput(inputPath);\n    }\n    host.compile();\n    heimdall.stop(token);\n  }\n}\n","import * as ts from \"typescript\";\nimport SourceCache from \"./source-cache\";\nimport OutputPatcher from \"./output-patcher\";\nimport { heimdall } from \"./helpers\";\n\nconst { sys } = ts;\n\nexport default class Compiler {\n  public config: ts.ParsedCommandLine;\n\n  private output: OutputPatcher;\n  private input: SourceCache;\n  private host: ts.CompilerHost;\n  private program: ts.Program;\n\n  constructor(public outputPath: string, public inputPath: string, public rawConfig: any, public configFileName: string | undefined) {\n    let output = new OutputPatcher(outputPath);\n    let config = parseConfig(inputPath, rawConfig, configFileName, undefined);\n    logDiagnostics(config.errors);\n    let input = new SourceCache(inputPath, config.options);\n    let host = createCompilerHost(input, output, config.options);\n    this.output = output;\n    this.config = config;\n    this.input = input;\n    this.host = host;\n  }\n\n  public updateInput(inputPath: string) {\n    // the config builds the list of files\n    let token = heimdall.start(\"TypeScript:updateInput\");\n    let config = this.config = parseConfig(inputPath, this.rawConfig, this.configFileName, this.config.options);\n    logDiagnostics(config.errors);\n    if (this.inputPath !== inputPath) {\n      this.inputPath = inputPath;\n      this.config = config;\n      this.input = new SourceCache(inputPath, config.options);\n      this.host = createCompilerHost(this.input, this.output, config.options);\n    } else {\n      this.input.updateCache();\n    }\n    heimdall.stop(token);\n  }\n\n  public compile() {\n    this.createProgram();\n    this.emitDiagnostics();\n    this.emitProgram();\n    this.patchOutput();\n  }\n\n  protected createProgram() {\n    let { config, host } = this;\n    let { fileNames, options } = config;\n    let token = heimdall.start(\"TypeScript:createProgram\");\n    let program = ts.createProgram(fileNames, options, host, this.program);\n    this.program = program;\n    heimdall.stop(token);\n  }\n\n  protected emitDiagnostics() {\n    // this is where bindings are resolved and typechecking is done\n    let token = heimdall.start(\"TypeScript:emitDiagnostics\");\n    let diagnostics = ts.getPreEmitDiagnostics(this.program);\n    logDiagnostics(diagnostics);\n    heimdall.stop(token);\n  }\n\n  protected emitProgram() {\n    let token = heimdall.start(\"TypeScript:emitProgram\");\n    let emitResult = this.program.emit();\n    logDiagnostics(emitResult.diagnostics);\n    heimdall.stop(token);\n  }\n\n  protected patchOutput() {\n    let token = heimdall.start(\"TypeScript:patchOutput\");\n    this.output.patch();\n    heimdall.stop(token);\n  }\n}\n\nfunction logDiagnostics(diagnostics: ts.Diagnostic[] | undefined) {\n  if (!diagnostics) return;\n  for (let i = 0; i < diagnostics.length; i++) {\n    let diagnostic = diagnostics[i];\n    let message = formatDiagnostic(diagnostic);\n    console.error(message);\n  }\n}\n\nfunction formatDiagnostic(d: ts.Diagnostic): string {\n  let msg = ts.flattenDiagnosticMessageText(d.messageText, sys.newLine);\n  if (!d.file) return msg;\n  return formatMessage(d.file, d.start, msg);\n}\n\nfunction formatMessage(sourceFile: ts.SourceFile, start: number, msg: string): string {\n  let loc = sourceFile.getLineAndCharacterOfPosition(start);\n  return `${ sourceFile.fileName }(${ loc.line + 1 },${ loc.character + 1 }): ${msg}`;\n}\n\nfunction parseConfig(inputPath: string, rawConfig: any, configFileName: string | undefined, previous?: ts.CompilerOptions) {\n  let host = createParseConfigHost(inputPath);\n  return ts.parseJsonConfigFileContent(rawConfig, host, \"/\", previous, configFileName);\n}\n\nfunction createParseConfigHost(inputPath: string): ts.ParseConfigHost {\n  let rootLength = inputPath.length;\n  let stripRoot = fileName => fileName.slice(rootLength);\n  let realPath = fileName => inputPath + fileName;\n  return {\n    useCaseSensitiveFileNames: ts.sys.useCaseSensitiveFileNames,\n    fileExists: path => sys.fileExists(realPath(path)),\n    readDirectory: (rootDir, extensions, excludes, includes) => sys.readDirectory(realPath(rootDir), extensions, excludes, includes).map(stripRoot)\n  };\n}\n\nfunction createCompilerHost(input: SourceCache, output: OutputPatcher, options: ts.CompilerOptions): ts.CompilerHost {\n  let newLine = getNewLine(options);\n  let caseSensitive = ts.sys.useCaseSensitiveFileNames;\n  return {\n    getCurrentDirectory: () => \"/\",\n    getNewLine: () => newLine,\n    useCaseSensitiveFileNames: () => caseSensitive,\n    getCanonicalFileName: fileName => caseSensitive ? fileName : fileName.toLowerCase(),\n    getSourceFile: (fileName: string, languageVersion: ts.ScriptTarget, onError: (message: string) => void) => input.getSourceFile(fileName, languageVersion, onError),\n    getDefaultLibFileName: () => input.libFileName,\n    getDirectories: path => ts.sys.getDirectories(input.realPath(path)),\n    fileExists: fileName => input.fileExists(fileName),\n    readFile: fileName => input.readFile(fileName),\n    writeFile: (fileName, content) => {\n      let relativePath = fileName.slice(1);\n      output.add(relativePath, content);\n    }\n  };\n}\n\nfunction getNewLine(options: ts.CompilerOptions) {\n  let newLine;\n  if (options.newLine === undefined) {\n    newLine = sys.newLine;\n  } else {\n    newLine = options.newLine === ts.NewLineKind.LineFeed ? \"\\n\" : \"\\r\\n\";\n  }\n  return newLine;\n}\n","import * as fs from \"fs\";\nimport { md5Hex, walkSync, WalkSync, FSTree } from \"./helpers\";\nimport { createMap } from \"./utils\";\n\nexport default class OutputPatcher {\n  private entries: WalkSync.Entry[] = [];\n  private contents = createMap<string>();\n  private lastTree: FSTree | undefined = undefined;\n  private isUnchanged: (a: Entry, b: Entry) => boolean;\n\n  constructor(private outputPath: string) {\n    this.isUnchanged = (entryA, entryB) => {\n      if (entryA.isDirectory() && entryB.isDirectory()) {\n        return true;\n      }\n      if (entryA.mode === entryB.mode && entryA.checksum === entryB.checksum) {\n        return true;\n      }\n      return false;\n    };\n  }\n\n  // relativePath should be without leading '/' and use forward slashes\n  public add(relativePath: string, content: string): void {\n    this.entries.push(new Entry(this.outputPath, relativePath, md5Hex(content)));\n    this.contents[relativePath] = content;\n  }\n\n  public patch() {\n    try {\n      this.lastTree = this._patch();\n    } catch (e) {\n      // walkSync(output);\n      this.lastTree = undefined;\n      throw e;\n    } finally {\n      this.entries = [];\n      this.contents = Object.create(null);\n    }\n  }\n\n  private _patch() {\n    let { entries, lastTree, isUnchanged, outputPath, contents } = this;\n    let nextTree = FSTree.fromEntries(entries, {\n      sortAndExpand: true\n    });\n    if (!lastTree) {\n      lastTree = FSTree.fromEntries(walkSync.entries(outputPath));\n    }\n    let patch = lastTree.calculatePatch(nextTree, isUnchanged);\n    patch.forEach(([op, path, entry]) => {\n      switch (op) {\n        case \"mkdir\":\n          // the expanded dirs don't have a base\n          fs.mkdirSync(outputPath + \"/\" + path);\n          break;\n        case \"rmdir\":\n          // the expanded dirs don't have a base\n          fs.rmdirSync(outputPath + \"/\" + path);\n          break;\n        case \"unlink\":\n          fs.unlinkSync(entry.fullPath);\n          break;\n        case \"create\":\n        case \"change\":\n          fs.writeFileSync(entry.fullPath, contents[path]);\n          break;\n      }\n    });\n    return nextTree;\n  }\n}\n\nclass Entry implements WalkSync.Entry {\n  public fullPath: string;\n  public mode: number = 0;\n  public size: number = 0;\n  public mtime: Date = new Date();\n\n  constructor(public basePath: string, public relativePath: string, public checksum: string) {\n    this.fullPath = basePath + \"/\" + relativePath;\n    this.checksum = checksum;\n  }\n\n  isDirectory() {\n    return false;\n  }\n}\n","import { FSTree, walkSync } from \"./helpers\";\nimport { createMap } from \"./utils\";\nimport { SourceFile, createSourceFile, ScriptTarget, sys, CompilerOptions, getDefaultLibFileName, getDefaultLibFilePath } from \"typescript\";\n\nexport default class SourceCache {\n  private lastTree: FSTree | undefined = undefined;\n  private cache = createMap<SourceFile>();\n  private charset: string | undefined;\n  public libFileName: string;\n  private libFilePath: string;\n\n  constructor(public inputPath: string,\n              public options: CompilerOptions) {\n    this.charset = options.charset;\n    this.libFileName = \"/__\" + getDefaultLibFileName(options);\n    this.libFilePath = getDefaultLibFilePath(options);\n  }\n\n  public updateCache() {\n    let nextTree = FSTree.fromEntries(walkSync.entries(this.inputPath));\n    let cache = this.cache;\n    let lastTree = this.lastTree;\n    if (lastTree) {\n      lastTree.calculatePatch(nextTree).forEach(([op, path]) => {\n        switch (op) {\n          case \"unlink\":\n          case \"create\":\n          case \"change\":\n            cache[\"/\" + path] = undefined;\n            break;\n        }\n      });\n    }\n    this.lastTree = nextTree;\n  }\n\n  public realPath(fileName) {\n    if (this.libFileName === fileName) {\n      return this.libFilePath;\n    }\n    return this.inputPath + fileName;\n  }\n\n  public fileExists(fileName) {\n    return sys.fileExists(this.realPath(fileName));\n  }\n\n  public readFile(fileName: string): string {\n    let { cache } = this;\n    let content = cache[fileName];\n    if (content !== undefined) {\n      return content.text;\n    }\n    return sys.readFile(this.realPath(fileName), this.charset);\n  }\n\n  public getSourceFile(fileName: string, languageVersion: ScriptTarget, onError: (message: string) => void): SourceFile {\n    let { cache } = this;\n    let sourceFile = cache[fileName];\n    if (!sourceFile) {\n      let text;\n      try {\n        text = this.readFile(fileName);\n      } catch (e) {\n        if (onError) {\n          onError(e.message);\n        }\n        text = \"\";\n      }\n      sourceFile = cache[fileName] = createSourceFile(fileName, text, languageVersion);\n    }\n    return sourceFile;\n  }\n}\n\n","import { readConfigFile, flattenDiagnosticMessageText, sys } from \"typescript\";\nimport { findup } from \"./helpers\";\nimport { join } from \"path\";\n\nexport function findConfig(root: string): string {\n  return join(findup.sync(root, \"package.json\"), \"tsconfig.json\");\n}\n\nexport function readConfig(configFile: string): any {\n  let result = readConfigFile(configFile, sys.readFile);\n  if (result.error) {\n    let message = flattenDiagnosticMessageText(result.error.messageText, \"\\n\");\n    throw new Error(message);\n  }\n  return result.config;\n}\n\nconst { create: createObject } = Object;\n\nexport interface Map<T> {\n  [key: string]: T | undefined;\n}\n\nexport function createMap<T>(): Map<T> {\n    const map: Map<T> = createObject(null);\n    map[\"__\"] = undefined;\n    delete map[\"__\"];\n    return map;\n}\n","export const FSTree: FSTree.Static = require(\"fs-tree-diff\");\nexport const BroccoliPlugin: BroccoliPlugin.Static = require(\"broccoli-plugin\");\nexport const walkSync: WalkSync = require(\"walk-sync\");\nexport const md5Hex: MD5Hex = require(\"md5-hex\");\nexport const findup: FindUp = require(\"findup\");\nexport const getCallerFile: GetCallerFile = require(\"get-caller-file\");\nexport const heimdall: Heimdall = require(\"heimdalljs\");\n\ndeclare function require(id: string): any;\n\nexport interface Token {}\nexport interface Heimdall {\n  start(name: string): Token;\n  stop(token: Token);\n}\n\nexport interface MD5Hex {\n  (str: string): string;\n}\n\nexport interface GetCallerFile {\n  (pos?: number): string;\n}\n\nexport interface FindUp {\n  sync(dir: string, file: string): string;\n}\n\nexport namespace BroccoliPlugin {\n  export interface PluginOptions {\n    name?: string;\n    annotation?: string;\n    persistentOutput?: boolean;\n  }\n\n  export interface Plugin {\n    inputPaths: string[];\n    outputPath: string;\n    cachePath: string;\n  }\n\n  export interface Static {\n    new (inputNodes: any[], options?: any): Plugin;\n  }\n}\n\nexport interface WalkSync {\n  (path: string, options?: WalkSync.Options): string[];\n  entries(path: string, options?: WalkSync.Options): WalkSync.Entry[];\n}\n\nexport namespace WalkSync {\n  export type Row = string | RegExp[];\n\n  export type Options = {\n    globs?: (string | { match(): boolean })[];\n  };\n\n  export interface Entry {\n    relativePath: string;\n    basePath: string;\n    fullPath: string;\n    mode: number;\n    size: number;\n    mtime: Date;\n    isDirectory(): boolean;\n  }\n}\n\nexport interface FSTree {\n  calculatePatch(next: FSTree, isUnchanged?: (a: WalkSync.Entry, b: WalkSync.Entry) => {}): FSTree.PatchOp[];\n}\n\nexport namespace FSTree {\n  export type Op = \"unlink\" | \"create\" | \"mkdir\" | \"rmdir\" | \"change\";\n\n  export type PatchOp = [Op, string, WalkSync.Entry];\n\n  export interface Static {\n    fromEntries(entries: WalkSync.Entry[], options?: {\n      sortAndExpand?: boolean\n    }): FSTree;\n  }\n}\n"],"names":["let","super","ts.NewLineKind","sys","path","ts.sys","ts.parseJsonConfigFileContent","ts.flattenDiagnosticMessageText","ts.getPreEmitDiagnostics","ts.createProgram","fs.writeFileSync","fs.unlinkSync","fs.rmdirSync","fs.mkdirSync","createSourceFile","getDefaultLibFilePath","getDefaultLibFileName","const","flattenDiagnosticMessageText","readConfigFile","join"],"mappings":"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"}